name: CI

on:
  push:
    branches: [ main, sprint11-resampling ]
  pull_request:
    branches: [ main, sprint11-resampling ]

jobs:
  lint:
    name: Lint and Format Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install flake8 black isort
      
      - name: Check code formatting (black)
        run: |
          black --check src/ tests/ || echo "Code formatting issues found. Run: black src/ tests/"
      
      - name: Check import sorting (isort)
        run: |
          isort --check-only src/ tests/ || echo "Import sorting issues found. Run: isort src/ tests/"
      
      - name: Lint with flake8
        run: |
          flake8 src/ tests/ --count --select=E9,F63,F7,F82 --show-source --statistics
          flake8 src/ tests/ --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Run unit tests
        env:
          PYTHONPATH: src
        run: |
          pytest tests/ -v --tb=short
      
      - name: Run tests with coverage (if pytest-cov installed)
        env:
          PYTHONPATH: src
        run: |
          pytest tests/ --cov=src --cov-report=xml --cov-report=term-missing || pytest tests/ -v

  smoke-test:
    name: LSFT Smoke Test
    runs-on: ubuntu-latest
    needs: [lint, test]
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Verify imports work
        env:
          PYTHONPATH: src
        run: |
          python -c "
          from goal_1_similarity import *
          from goal_2_baselines import *
          from goal_3_prediction import *
          from shared import *
          print('✓ All imports successful')
          "
      
      - name: Verify CLI entry point exists
        env:
          PYTHONPATH: src
        run: |
          python src/main.py --help || echo "CLI help check"
      
      - name: Check key modules exist
        run: |
          test -f src/goal_3_prediction/lsft/lsft.py && echo "✓ LSFT module exists" || exit 1
          test -f src/shared/linear_model.py && echo "✓ Linear model exists" || exit 1
          test -f src/shared/metrics.py && echo "✓ Metrics module exists" || exit 1

